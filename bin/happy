#!/usr/bin/env node

/**
 * Module dependencies.
 */

var programme = require('celeri'),
    sys = require('sys'),
    spawn = require('child_process').spawn,
    fs = require('fs-extra'),
    readline = require('readline')
    moment = require('moment'),
    bower = require('bower');

// Config
bower.config.directory = 'themes';

programme.usage('happy [command]');

/**
 * Order is from bottom to top, celeri requirement.
 */
programme.option({
  command: 'theme use :theme',
  description: 'Use a theme. (Warning: it will overwrite your current src files)'
}, function(data) {
  fs.copy('themes/' + data.theme, 'src', function(err) {
    if (err) {
      console.error('➤ There\'s an error with "' + data.theme + '" theme. Are you sure it\'s the correct name?');
      console.error('');
      console.error('DEBUG:');
      console.error(err);
    }
    else {
      console.log('➤ You now use "' + data.theme + '" theme.');
    }
  });
});

programme.option({
  command: 'theme install :theme',
  description: 'Install a theme.'
}, function(data) {
  var error = false;

  bower
    .commands
    .install([data.theme])
    .on('error', function() {
      console.log('➤ Error during installation of "' + data.theme + '" theme.');
      error = true;
    })
    .on('end', function () {
      if(!error) {
        console.log('➤ "' + data.theme + '" installed.');
      }
    });
});

programme.option({
    command: 'publish',
    description: 'Publish on a certain branch (like gh-pages).'
}, function() {
    var grunt = spawn('grunt', ['dist']);

    grunt.stdout.on('data', function (data) {
      process.stdout.write('' + data);
    });
});

programme.option({
    command: 'newpost :name',
    description: 'Create a new post. Example: newpost "This is my new post\!"'
}, function(data) {
    // Config
    var basePath = 'src/',
        postName = 'fixme';
        currentDate = moment().format('YYYY-MM-DD'),
        answer = data.name;

    if(answer !== '') {
      postName = answer;
    }

    // Template
    var fileContent = [
      '---',
      'layout: post',
      'title: "' + postName + '"',
      'tags: [\'removemeifunneeded\']',
      '---'
    ].join('\n');

    var fileName = basePath + '_posts/_drafts/' + currentDate + '-' + postName.toLowerCase().split(' ').join('-').split(',').join('') + '.md';

    fs.writeFile(fileName, fileContent);

    console.log('Your new post was created: ' + fileName + '. Have fun!');
});

programme.option({
    command: 'dist',
    description: 'Distributing mode.'
}, function() {
    var grunt = spawn('grunt', ['dist']);

    grunt.stdout.on('data', function (data) {
      process.stdout.write('' + data);
    });
});


programme.option({
    command: 'dev',
    description: 'Development mode.'
}, function() {
    var grunt = spawn('grunt');

    grunt.stdout.on('data', function (data) {
      process.stdout.write('' + data);
    });
});

programme.option({
    command: 'init',
    description: 'Initialise the project.'
}, function() {
    var grunt = spawn('grunt', ['happyPlan:init']);

    grunt.stdout.on('data', function (data) {
      process.stdout.write('' + data);
    });
});

if(process.argv.length == 2) {
  programme.help();
}

programme.parse(process.argv);

